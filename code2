/**
 * Multiple images â†’ uniquely named CID inline images
 * Outlook safe
 */

const items = $input.all();

let htmlBlocks = [];
let binary = {};
let index = 0;

for (const item of items) {
  if (!item.binary) continue;

  // Detect the binary key dynamically
  const binaryKey = Object.keys(item.binary)[0];
  if (!binaryKey) continue;

  const img = item.binary[binaryKey];

  // Determine file extension safely
  let extension = 'png';
  if (img.fileName && img.fileName.includes('.')) {
    extension = img.fileName.split('.').pop();
  } else if (img.mimeType) {
    extension = img.mimeType.split('/').pop();
  }

  const cid = `img_${index}@mail`;
  const outKey = `image_${index}`;
  const fileName = `dashboard-image-${index}.${extension}`;

  binary[outKey] = {
    data: img.data,                     // Base64
    mimeType: img.mimeType || `image/${extension}`,
    fileName,                           // UNIQUE filename
    cid,                                // UNIQUE CID
    disposition: 'inline'               // REQUIRED for Outlook
  };

  htmlBlocks.push(`
    <div style="margin:20px 0;">
      <img src="cid:${cid}" style="width:100%; max-width:800px;" />
    </div>
  `);

  index++;
}

if (index === 0) {
  throw new Error('No images found. Check HTTP Request â†’ Response Format = File');
}

return [
  {
    json: {
      subject: 'Grafana Dashboard Report',
      html: `
        <html>
          <body style="font-family:Arial, sans-serif; max-width:800px; margin:auto;">
            <h2>ðŸ“Š Grafana Dashboard Report</h2>
            ${htmlBlocks.join('')}
            <div style="margin-top:30px; font-size:12px; color:#64748b;">
              Automatically generated by n8n workflow
            </div>
          </body>
        </html>
      `
    },
    binary
  }
];
